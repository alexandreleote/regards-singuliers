{% extends 'base.html.twig' %}

{% block title %}Gérer les liens Calendly{% endblock %}

{% block body %}
<div class="container mt-4">
    <h1>Gérer les liens Calendly</h1>
    
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Titre du service</th>
                <th>Slug</th>
                <th>Lien Calendly</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for service in services %}
            <tr>
                <td>{{ service.id }}</td>
                <td>{{ service.title }}</td>
                <td>{{ service.slug }}</td>
                <td>
                    <input type="text" 
                           class="form-control calendly-link-input" 
                           data-service-id="{{ service.id }}" 
                           value="{{ service.calendly_link ?? '' }}"
                           placeholder="Entrez le lien Calendly">
                </td>
                <td>
                    <button class="btn btn-primary save-calendly-link" 
                            data-service-id="{{ service.id }}">
                        Enregistrer
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const saveButtons = document.querySelectorAll('.save-calendly-link');
    
    saveButtons.forEach(button => {
        button.addEventListener('click', function() {
            const serviceId = this.dataset.serviceId;
            const linkInput = document.querySelector(`.calendly-link-input[data-service-id="${serviceId}"]`);
            const calendlyLink = linkInput.value.trim();

            fetch(`/service/${serviceId}/set-calendly-link`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `calendly_link=${encodeURIComponent(calendlyLink)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Lien Calendly mis à jour avec succès');
                } else {
                    alert('Erreur : ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur est survenue');
            });
        });
    });
});
</script>
{% endblock %}
