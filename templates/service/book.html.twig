{% extends 'base.html.twig' %}

{% block title %}R√©server {{ service.title }}{% endblock %}

{% block body %}
    <div class="container mt-4 booking-container">
        <h1>R√©server {{ service.title }}</h1>
        
        <div class="booking-form-container">
            {% if service.isActive %}
                <div class="service-description mb-4">
                    <h2>Description du service</h2>
                    <p>{{ service.description }}</p>
                </div>

                <div class="payment-section">
                    <h2>√âtape 1 : Paiement</h2>
                    <p>Montant : {{ service.price }}‚Ç¨</p>
                    
                    <form action="{{ path('create_checkout_session', {'serviceId': service.id}) }}" method="POST">
                        <button type="submit" class="btn btn-primary">
                            Proc√©der au Paiement
                        </button>
                    </form>
                </div>

                <div class="calendly-section" style="display:none;">
                    <h2>√âtape 2 : R√©servation</h2>
                    {% if service.calendlyLink %}
                        <div id="calendly-widget-container" class="calendly-inline-widget" 
                             data-url="{{ service.calendlyLink }}" 
                             style="min-width:320px;height:700px;position:relative;">
                            <div id="calendly-loading" class="text-center p-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <p>Chargement du calendrier de r√©servation...</p>
                            </div>
                        </div>
                        
                        <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js" 
                                async 
                                onload="handleCalendlyLoad()" 
                                onerror="handleCalendlyLoadError()"></script>
                    {% else %}
                        <div class="alert alert-warning">
                            <h4>R√©servation temporairement indisponible</h4>
                            <p>La r√©servation en ligne pour ce service est actuellement en cours de configuration.</p>
                            <p>Veuillez nous contacter directement pour planifier votre rendez-vous :</p>
                            <ul>
                                <li>üìû Par t√©l√©phone</li>
                                <li>‚úâÔ∏è Par email</li>
                                <li>üí¨ Via nos r√©seaux sociaux</li>
                            </ul>
                        </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const stripe = Stripe('{{ stripe_public_key }}');
            
            const paymentForm = document.querySelector('form');
            paymentForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                fetch(this.action, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = response.url;
                    }
                });
            });
        });

        function handleCalendlyLoad() {
            console.log('Calendly widget loaded successfully');
            document.getElementById('calendly-loading').style.display = 'none';
            document.querySelector('.calendly-section').style.display = 'block';
        }

        function handleCalendlyLoadError() {
            console.error('Failed to load Calendly widget');
            const widgetContainer = document.getElementById('calendly-widget-container');
            widgetContainer.innerHTML = `
                <div class="alert alert-danger">
                    <h4>Erreur de chargement</h4>
                    <p>Le calendrier de r√©servation n'a pas pu √™tre charg√©. Veuillez r√©essayer ult√©rieurement.</p>
                    <p>Si le probl√®me persiste, contactez le support technique.</p>
                </div>
            `;
        }
    </script>
{% endblock %}